<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interest List | SideQuest Co Shop</title>
    <link href="dist/styles.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Marcellus&display=swap" rel="stylesheet">
        <style>
            body {
                font-family: 'Marcellus', sans-serif;
            }
    </style>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body class="bg-white min-h-screen">
    <script>
        if (sessionStorage.getItem('authenticated') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <header class="py-6 mb-8 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <a href="/"><img src="images/invert1.png" alt="Shop Logo" class="h-20 mx-auto"></a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-16">
        <h1 class="text-3xl font-light text-primary mb-8">Request a Wholesale Quote</h1>
        <div id="orderFormContainer">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3">Product</th>
                        <th scope="col" class="px-6 py-3">Price</th>
                        <th scope="col" class="px-6 py-3">Quantity</th>
                        <th scope="col" class="px-6 py-3">Total</th>
                    </tr>
                </thead>
                <tbody id="interestListContainer">
                    <!-- Order items will be injected here -->
                </tbody>
            </table>
            <div class="mt-8 flex justify-end">
                <div class="w-full max-w-sm">
                    <div class="flex justify-between py-2">
                        <span>Subtotal</span>
                        <span id="subtotal"></span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span>Tax</span>
                        <span id="tax">Calculated Later</span>
                    </div>
                    <div class="flex justify-between py-2">
                        <span>Shipping</span>
                        <span>Calculated Later</span>
                    </div>
                    <div class="flex justify-between font-bold py-2">
                        <span>Total</span>
                        <span id="total"></span>
                    </div>
                </div>
            </div>
        </div>
<div class="mt-8">
                <h2 class="text-2xl font-light text-primary mb-4">Your Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block mb-2 text-sm font-medium text-gray-900">Name or Company</label>
                        <input type="text" id="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div>
                        <label for="email" class="block mb-2 text-sm font-medium text-gray-900">Email</label>
                        <input type="email" id="email" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div>
                            <label for="country" class="block mb-2 text-sm font-medium text-gray-900">Country</label>
                            <select id="country" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option>Canada</option>
                                <option>United States</option>
                            </select>
                        </div>
                        <div>
                            <label for="province" class="block mb-2 text-sm font-medium text-gray-900">Province/State</label>
                            <input type="text" id="province" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                        <div>
                            <label for="postal" class="block mb-2 text-sm font-medium text-gray-900">Postal/Zip Code</label>
                            <input type="text" id="postal" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" required>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button id="submitOrder" class="bg-primary text-white text-center py-3 px-8 text-sm font-medium hover:bg-opacity-90 transition-colors duration-300 rounded-lg">
                    Request Quote
                </button>
            </div>
    </main>

    <script src="js/products.js?v=1.1"></script>
    <script src="js/interest-list.js"></script>
    <script>
        const interestListContainer = document.getElementById('interestListContainer');
        const subtotalElement = document.getElementById('subtotal');
        const taxElement = document.getElementById('tax');
        const totalElement = document.getElementById('total');
        const interestList = JSON.parse(sessionStorage.getItem('interestList')) || [];

        function calculateTotals() {
            let subtotal = 0;
            const quantityInputs = document.querySelectorAll('.quantity-input');
            quantityInputs.forEach(input => {
                const productId = input.dataset.productId;
                const product = products.find(p => p.listing_id === productId);
                if (product) {
                    const quantity = parseInt(input.value) || 0;
                    const lineTotal = quantity * product.wholesale_price;
                    document.getElementById(`line-total-${productId}`).textContent = `${product.currency} ${lineTotal.toFixed(2)}`;
                    subtotal += lineTotal;
                }
            });

            const total = subtotal;

            subtotalElement.textContent = `CAD ${subtotal.toFixed(2)}`;
            totalElement.textContent = `CAD ${total.toFixed(2)}`;
        }

        if (interestList.length === 0) {
            document.getElementById('orderFormContainer').innerHTML = '<p>You have not added any products to your interest list yet.</p>';
        } else {
            interestList.forEach(productId => {
                const product = products.find(p => p.listing_id === productId);
                if (product) {
                    const productRow = `
                        <tr class="bg-white border-b">
                            <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                                <div class="flex items-center">
                                    <img src="${product.imageUrl}" alt="${product.title}" class="w-16 h-16 object-cover mr-4">
                                    <a href="product.html?id=${product.listing_id}" class="hover:underline">${product.title}</a>
                                </div>
                            </td>
                            <td class="px-6 py-4">${product.currency} ${product.wholesale_price.toFixed(2)}</td>
                            <td class="px-6 py-4">
                                <input type="number" min="5" value="5" class="quantity-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5" data-product-id="${product.listing_id}">
                            </td>
                            <td class="px-6 py-4" id="line-total-${product.listing_id}">${product.currency} ${(product.wholesale_price * 5).toFixed(2)}</td>
                        </tr>
                    `;
                    interestListContainer.insertAdjacentHTML('beforeend', productRow);
                }
            });

            const quantityInputs = document.querySelectorAll('.quantity-input');
            quantityInputs.forEach(input => {
                input.addEventListener('change', calculateTotals);
                input.addEventListener('keyup', calculateTotals);
            });

const submitOrderButton = document.getElementById('submitOrder');
        submitOrderButton.addEventListener('click', () => {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const country = document.getElementById('country').value;
            const province = document.getElementById('province').value;
            const postal = document.getElementById('postal').value;

            if (!name || !email || !country || !province || !postal) {
                alert('Please fill out all the details.');
                return;
            }

            const order_id = `SQC-${Date.now()}`;
            const orders = [];
            let subtotal = 0;

            const quantityInputs = document.querySelectorAll('.quantity-input');
            quantityInputs.forEach(input => {
                const productId = input.dataset.productId;
                const product = products.find(p => p.listing_id === productId);
                if (product) {
                    const quantity = parseInt(input.value) || 0;
                    if (quantity > 0) {
                        orders.push({
                            name: product.title,
                            units: quantity,
                            price: product.wholesale_price.toFixed(2),
                            image_url: product.imageUrl
                        });
                        subtotal += quantity * product.wholesale_price;
                    }
                }
            });

            const tax = subtotal * 0.05;
            const total = subtotal + tax;

            const serviceID = 'service_isnlg8x';
            const templateID = 'template_oaou2rj';
            const userID = 'nFEgMLeXdTAiNvXjQ';

            const templateParams = {
                order_id: order_id,
                orders: orders,
                cost: {
                    shipping: 'Calculated Later',
                    tax: 'Calculated Later',
                    total: total.toFixed(2)
                },
                email: email,
                from_name: name,
                country: country,
                province: province,
                postal: postal
            };

            emailjs.send(serviceID, templateID, templateParams, userID)
                .then((response) => {
                   console.log('SUCCESS!', response.status, response.text);
                   alert('Your quote request has been sent successfully!');
                }, (error) => {
                   console.log('FAILED...', error);
                   alert('There was an error sending your quote request. Please try again later.');
                });
        });
            calculateTotals();
        }
    </script>
</body>
</html>